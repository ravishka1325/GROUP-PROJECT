<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/booking.css">
    <link rel="stylesheet" href="css/usernav.css">
    <link rel="icon" type="image/x-icon" href="/favicon/favicon-16x16.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<title>GoAppoint | Book Appointment</title>
</head>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="Js/jquery-3.7.1.min.js"></script>
    
<body>
    <nav>
        <a href="userindex.html"><button class="logo-btn"><img class="logo" src="assets/logo.png" alt="GoAppoint"></button></a>
             <div class="links">
                 
                 <label class="dropdown">
 
                     <div class="dd-button">
                         <a style="background-color: #efefe9;"><i style="background-color: #efefe9; " class="fa-solid fa-user"></i></a>
                         <p style="margin: 0; background-color: #efefe9;"><span id="fname"></span></p>
                     </div>
                   
                     <input type="checkbox" class="dd-input" id="test">
                   
                     <ul class="dd-menu">
                       <li><a style="border-radius: 20px 20px 0px 0px;" href="Userprofile.html"><i class="fa-regular fa-user"></i> Profile</a></li>
                       <li><a href="userAppointments.html"><i class="fa-solid fa-business-time"></i> My Appointments</a></li>
                       <button id="logoutButton" style="border-radius: 0px 0px 20px 20px; border: none;  background-color: #fff0;" onclick="logout()"><li><i class="fa-solid fa-right-from-bracket" style="background-color: #fff0;"></i> Sign out</li></button>
                     </ul>
                     
                   </label>
             </div>      
             
     </nav>
     <script>
        let fname = sessionStorage.getItem("fname");
        document.getElementById("fname").innerText = fname;
    </script>
    
    <section>
        <div class="container">
            <div class="as-heading">
                <p><span id="businessName"></span></p>
            </div>
            <div class="addservice-form">
                <div class="asf-content">
                    <form id="appointmentForm" class="form" method="POST">

                        <div class="input-boxes">
                            <label class="input_label" for="serviceSelect">Select a service:</label>
                            <select class="as-input" id="serviceSelect"></select>
                        </div>
    
                        <div class="input-boxes">
                            <label class="input_label" for="appointmentDateTime">Appointment Date and Time:</label>
                            <p style="font-size: 12px; font-weight: bold;">(Check the Business Hours and Place Appointment 30min time period - Ex: 08:30AM, 10:00AM)</p>
                            <input class="as-input" type="datetime-local" id="appointmentDateTime" name="appointmentDateTime" min="2024-03-20T08:30" max="" step="1800" required>
                        </div>
                
                        <div class="sc-btn">
                            <button type="button" class="btn btn-dark" id="bookNowButton">Book Now</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <div class="footer-container">
        <footer class="footer">
            <div class="footer-content">
        <div class="footer-column1">
            
            <img src="assets/logo.png" alt="footer logo">
            <div class="s-icon">
                <div class="follow">
                    <p class="p-follow">FOLLOW US</p>
                </div>
            <a href="https://www.facebook.com/" target="parent"><i class="fa-brands fa-facebook"></i></a>
            <a href="https://www.instagram.com/" target="parent"><i class="fa-brands fa-instagram"></i></a>
            <a href="https://twitter.com/?lang=en" target="parent"><i class="fa-brands fa-square-x-twitter"></i></a>
            <a href="https://www.tiktok.com/en/" target="parent"><i class="fa-brands fa-tiktok"></i></a>
            </div>
            
            
        </div>
        
        <div class="vl"></div>
        
        <div class="footer-column">
            <h2 class="navtitle">GoAppoint Business</h2>
            <li>
                <a href="BusinessRegistration.html">Register your Business</a>
            </li>
            <li>
                <a href="BusinessLogin.html">Login to your Business</a>
            </li>
        </div>
        
        <div class="footer-column">
                <h2 class="navtitle">Company</h2>
                <li>
                    <a href="#">Contact Us</a>
                </li>
                <li>
                    <a href="#">About Us</a>
                </li>
                <li>
                    <a href="#">Terms of Use</a>
                </li>
                <li>
                    <a href="#">Privacy Policy</a>
                </li>
        </div>
        
        <div class="footer-column">
                <h2 class="navtitle">Businesses</h2>
                <li>
                    <a href="#">Saloon & Beauty</a>
                </li>
                <li>
                    <a href="#">Barber</a>
                </li>
                <li>
                    <a href="#">Tattoo</a>
                </li>
                <li>
                    <a href="#">Legal Services</a>
                </li>
                <li>
                    <a href="#">Car Services</a>
                </li>    
            </li>
            </ul>
        </div>
        </div>
        </div>
        
        <div class="footer-container2">
           <p class="text">Copyright Â© GoAppoint 2024</p>
        </div>
        </body>
        </footer>

    <script>
        function getQueryParams() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const params = {};
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            return params;
        }

        function fetchServices(businessId) {
            $.ajax({
                url: `http://localhost:8080/api/v1/service/getService/${businessId}`,
                type: 'GET',
                success: function(response) {
                    if (response.code === 'RSP_SUCCESS') {
                        displayServices(response.content);
                    } else {
                        displayServices(response.content);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching services:', error);
                }
            });
        }

        function displayServices(services) {
            const serviceSelect = document.getElementById('serviceSelect');
            serviceSelect.innerHTML = ''; 

            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.serviceId;
                option.textContent = service.serviceName;
                serviceSelect.appendChild(option);
            });
        }

        function displayBusinessDetails(businessId, businessName) {
            document.getElementById('businessName').textContent = decodeURIComponent(businessName);
        }

        function handleFormSubmit() {
            const userId = sessionStorage.getItem("id");

            const queryParams = new URLSearchParams(window.location.search);
            const businessId = queryParams.get("id");
            const businessName = decodeURIComponent(queryParams.get("name"));

            const serviceId = document.getElementById("serviceSelect").value;
            const appointmentDateTime = document.getElementById("appointmentDateTime").value;

            const appointmentData = {
                userId: userId,
                businessId: businessId,
                serviceId: serviceId,
                appointmentDateTime: appointmentDateTime
            };

            $.ajax({
                method: "POST",
                url: "http://localhost:8080/api/v1/appointment/createAppointment",
                contentType: "application/json",
                data: JSON.stringify(appointmentData),
                success: function(response, status, xhr) {
                    if (xhr.status === 200) {
                        sendEmail();
                        alert("Appointment created successfully");
                        window.location.href = 'userindex.html';
                    } else {
                        console.error("Error creating appointment:", xhr.status, response);
                        alert("Please choose another time. This time is already booked")
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX request failed:", xhr.status, error);
                    alert("Please choose another time. This time is already booked")
                }
            });
        }

        function sendEmail() {
            emailjs.init("5kn-C6AOOsXF5Hp_k");

            var params = {
                to_email: sessionStorage.getItem("email"),
                from_name: sessionStorage.getItem("lname"),
                message: `Appointment created successfully`,
            };

            emailjs.send("service_ywpyd3q", "template_gwzalgo", params)
                    .then(function (response) {
                        console.log('Email sent successfully:', response);
                    }, function (error) {
                        console.error('Error sending email:', error);
                    });
        }

        const queryParams = getQueryParams();
        const businessId = queryParams.id;
        const businessName = queryParams.name;

        displayBusinessDetails(businessId, businessName);

        fetchServices(businessId);

        const bookNowButton = document.getElementById("bookNowButton");
        bookNowButton.addEventListener("click", handleFormSubmit);
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</body>
</html>